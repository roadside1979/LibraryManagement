<!DOCTYPE html>
<html>
<head>
  <title>蔵書管理システム</title>
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
</head>
<body>
  <h1>蔵書管理システム</h1>
  <form id="addBookForm">
    <!-- 既存の蔵書登録フォーム -->
    <input type="text" name="isbn" placeholder="ISBNコード" required><br>
    <input type="text" name="title" placeholder="タイトル" required><br>
    <input type="text" name="author" placeholder="著者" required><br>
    <input type="number" name="year" placeholder="出版年" required><br>
    <input type="text" name="genre" placeholder="ジャンル" required><br>
    <select name="location" required>
      <option value="自宅">自宅</option>
      <option value="研究室">研究室</option>
    </select><br>
    <select name="status" required>
      <option value="在庫">在庫</option>
      <option value="貸出中">貸出中</option>
    </select><br>
    <button type="submit">登録</button>
  </form>


  <form id="isbnForm">
    <!-- ISBNスキャン用の新しいフォーム -->  
    <input type="text" id="isbnInput" placeholder="ISBNコード" required>
    <button type="button" onclick="fetchBookInfo()">スキャンして取得</button>
  </form>

  <script>
    document.getElementById('addBookForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const params = new URLSearchParams(formData).toString();
      const response = await fetch('https://script.google.com/macros/s/AKfycbzefs0Z-dnk_trUBQoMtabhqhujLYA-v4jJJywTXyOoMSmQ_JZr-s-3_a3sftao3QRDSg/exec?action=addBook&' + params);
      const result = await response.json();
      if (result.success) {
        alert('蔵書を登録しました！');
        e.target.reset(); // フォームをリセット
      } else {
        alert('登録に失敗しました。');
      }
    });
  </script>
  
  <script>
  const API_KEY = 'AIzaSyCPhpJyXS6o8dL4K_o9M2ZDLYm9NWBQQxw'; // GCPで取得したAPIキーに置き換え

  async function fetchBookInfo() {
  const isbn = document.getElementById('isbnInput').value;
  if (!isbn) {
    alert('ISBNコードを入力してください。');
    return;
  }

  const url = `https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}&key=${API_KEY}`;
  try {
    const response = await fetch(url);
    const data = await response.json();

    if (data.totalItems === 0) {
      alert('該当する本が見つかりませんでした。');
      return;
    }

    const book = data.items[0].volumeInfo;

    // APIから取得したデータをスプレッドシートに送信
    const params = new URLSearchParams({
      isbn: isbn,
      title: book.title || '',
      author: book.authors ? book.authors.join(', ') : '',
      year: book.publishedDate ? book.publishedDate.split('-')[0] : '',
      genre: book.categories ? book.categories[0] : '',
      location: '自宅', // 所蔵場所のデフォルト値（必要に応じて変更）
      status: '在庫'   // 貸出状況のデフォルト値
    });

    const addBookUrl = 'https://script.google.com/macros/s/AKfycbzefs0Z-dnk_trUBQoMtabhqhujLYA-v4jJJywTXyOoMSmQ_JZr-s-3_a3sftao3QRDSg/exec?action=addBook&' + params;
    const addBookResponse = await fetch(addBookUrl);
    const result = await addBookResponse.json();

    if (result.success) {
      alert('本の情報をスプレッドシートに登録しました！');
    } else {
      alert('スプレッドシートへの登録に失敗しました。');
    }
  } catch (error) {
    console.error('エラー:', error);
    alert('情報の取得に失敗しました。');
  }
}
</script>

<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
<!-- バーコード読取りライブラリ -->

<div>
  <div id="reader" style="width: 300px;"></div>
  <button id="stopScan" style="display:none;">スキャン停止</button>
</div>
<!-- バーコードスキャンのUIを追加 -->

<script>
  let html5QrcodeScanner;

  // バーコードスキャンの初期化と処理
  function startBarcodeScan() {
  const qrCodeSuccessCallback = async (decodedText, decodedResult) => {
    alert(`ISBN: ${decodedText} をスキャンしました！`);
      
      // ISBNコードをGoogle Books APIに送信
      document.getElementById('isbnInput').value = decodedText;
    await fetchBookInfo(); // 既存の fetchBookInfo 関数を呼び出す
      
      // スキャン停止
      html5QrcodeScanner.clear();
      document.getElementById('stopScan').style.display = "none";
    };

    const config = { fps: 10, qrbox: 250 }; // スキャンの設定
    html5QrcodeScanner = new Html5Qrcode("reader");
    html5QrcodeScanner.start(
  { facingMode: "environment" }, // スマホの背面カメラを使用
  config,
  qrCodeSuccessCallback
).catch(err => {
  console.error("スキャン開始エラー:", err); // 詳細なエラーをコンソールに出力
  alert("カメラの起動に失敗しました。エラー内容: " + err.message);
});

	
    document.getElementById('stopScan').style.display = "block";
  }

  // スキャンを停止する処理
  document.getElementById('stopScan').addEventListener('click', () => {
    html5QrcodeScanner.clear();
    document.getElementById('stopScan').style.display = "none";
  });

  // ページ読み込み時にスキャンを開始するボタンを作成
  document.addEventListener('DOMContentLoaded', () => {
    const scanButton = document.createElement('button');
    scanButton.textContent = 'バーコードをスキャン';
    scanButton.onclick = startBarcodeScan;
    document.body.insertBefore(scanButton, document.getElementById('reader'));
  });
</script>

</body>
</html>
